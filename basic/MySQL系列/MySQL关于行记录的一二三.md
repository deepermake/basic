## MYSQL关于行记录的二三事

> compact行格式
> 数据页
> 16KB
> 行溢出
> 变长字段
> 逆序存放

一条记录在mysql中长什么样，包含了什么样的内容。
### 一条记录包含的内容

![P-10259032-10239559.jpg](https://github.com/deepermake/basic/blob/master/basic/img/mysql%E8%A1%8C%E8%AE%B0%E5%BD%95.png?raw=true)

* 变长字段长度列表：MySQL支持可变长度的数据类型，如VARCHAR，TEXT，BLOB，变长字段长度列表主要用来记录这些可变字段的实际长度，16进制且以逆序存储在列表中
NULL值列表，二进制存储，1代表列字段值为NULL，0-代表列字段值非NULL，默认位1字节，但默认空列个数超过8个时，会自动递增为2字节。
额外信息
* row_id：隐式id，如果没有建表主键且没有唯一索引时，会默认生成一个row_id，默认为6byte
* trx_id：事务id，6byte
* roll_pointer：回滚指针，指向记录的上一个版本，7byte
> trx_id和roll_pointer是innodb 实现MVCC（多版本控制）的关键

为什么变长字段长度列表和NULL值列表需要逆序存储？

* 记录是通过next_record连在一起的，next_record指向的是下一条数据的next_record和列信息的中间位置，所以读数据的时候也是想从next_record开始，往右是头信息，往左就是列信息，逆序存储可以方便的使真实数据和数据对应的长度信息根据next_record一一对称。
使得位置靠前的记录的真实数据和数据对应的字段长度信息可以同时在一个CPU Cache Line中，这样可以提高CPU Cache的命中率。

为什么需要记录可变字段长度？

为了方便查找。
* 磁盘为了能够存储更多的记录，所以每条记录都紧密挨着存储。拿varchar(5)举例，5表示字段最大的长度为5，但是实际上我们可以往里添加长度为1-5的任意字段。
现在存在两条记录"aa aa","  ab "，他们在磁盘的存储为"aa aa ab "，在磁盘中我们是无法直接确认哪段数据属于哪条记录，只有记录字段长度，才能确定。
MySQL： 23 VARCHAR可变长度字段在磁盘上的存储机制

列字段为NULL时，在磁盘是如何存储的
* 为了节约磁盘资源，在磁盘中不记录空列，而是将空列信息记录到NULL值列表中，统一管理

一条记录中有些部分固定存在，如“记录头信息”

红色的部分表示预留位（1、2），2bit
delete_mask：逻辑删除标志位，1-被删除，0-未删除，1bit
min_rec_mask：B+数每层非叶子节点中的最小记录都会添加该标记，1bit
n_owned：当前记录拥有的记录数，4bit

heap_no：堆号，记录在页中的偏移位置，13bit
record_type：记录类型，0-普通记录，1-B+树非叶子节点记录，2-最小记录，3-最大记录，3bit

next_record：偏移量，下一条记录的相对位置，当前记录的真实地址+next_record = 下一条记录的位置，2byte
一条记录，不管有多少列，其中有固定的5byte被记录的头信息占用。

一条记录的大小和那些因素有关系。
字段的长度
字符集
固定大小（记录头信息）
固定大小（记录头信息）

